generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  owner
  seller
  user
}

enum PaymentMethod {
  card
  transfer
  cash
  other
}

model Store {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  image       String?

  discountTarjeta       Float @default(1.0)
  discountTransferencia Float @default(1.0)
  discountEfectivo      Float @default(1.0)

  products    Product[]
  sales       Sale[]
  users       UserStore[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Product {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  image       String?
  price       Float
  stock       Int     @default(0)

  active      Boolean @default(true)

  store       Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId     Int

  saleItems   SaleItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Sale {
  id            Int           @id @default(autoincrement())

  store         Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId       Int


  seller        User          @relation(fields: [sellerId], references: [id])
  sellerId      Int

  date          DateTime      @default(now())
  total         Float
  paymentMethod PaymentMethod

  items         SaleItem[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([storeId])
  @@index([sellerId])
  @@index([date])
}

model SaleItem {
  id       Int     @id @default(autoincrement())
  name     String
  quantity Int
  price    Float
  image    String?

  sale      Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  saleId    Int

  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId Int?

  @@index([saleId])
}

model User {
  id       Int    @id @default(autoincrement())
  name     String
  email    String @unique
  image    String?
  role     Role   @default(user)
  password String?

  deletedAt DateTime?
  active    Boolean  @default(true)

  storesIds UserStore[]
  sales     Sale[]   // ventas realizadas por el usuario

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model UserStore {
  id      Int   @id @default(autoincrement())

  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  Int

  store   Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeId Int

  role    Role?

  @@unique([userId, storeId])
}
